{"version":3,"sources":["../../../src/layers/raster-layer.ts"],"names":["defaultProps","ColumnLayer","extruded","diskResolution","vertices","RasterColumnLayer","shaders","vs","attributeManager","getAttributeManager","addInstanced","instanceElevations","size","transition","accessor","instanceFillColors","props","colorFormat","length","type","normalized","defaultValue","instanceLineColors","RasterLayer","data","getElevation","getFillColor","getLineColor","getLineWidth","tileIndex","updateTriggers","blockWidth","blockHeight","xOffset","yOffset","scale","offset","CellLayer","getSubLayerClass","getSubLayerProps","id","getSubLayerAccessor","object","info","index","binaryData","proxy","cells","properties","CompositeLayer"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants';\nimport {\n  Accessor,\n  CompositeLayer,\n  CompositeLayerProps,\n  Layer,\n  LayersList,\n  DefaultProps\n} from '@deck.gl/core';\nimport {ColumnLayer, ColumnLayerProps} from '@deck.gl/layers';\nimport {quadbinToOffset} from './quadbin-utils';\nimport {Raster} from './schema/carto-raster-tile-loader';\nimport vs from './raster-layer-vertex.glsl';\nimport {assert, createBinaryProxy} from '../utils';\n\nconst defaultProps: DefaultProps<RasterLayerProps> = {\n  ...ColumnLayer.defaultProps,\n  extruded: false,\n  diskResolution: 4,\n  vertices: [\n    [-0.5, -0.5],\n    [0.5, -0.5],\n    [0.5, 0.5],\n    [-0.5, 0.5]\n  ]\n};\n\n// Modified ColumnLayer with custom vertex shader\nclass RasterColumnLayer extends ColumnLayer {\n  static layerName = 'RasterColumnLayer';\n\n  getShaders() {\n    const shaders = super.getShaders();\n    return {...shaders, vs};\n  }\n\n  initializeState() {\n    // Only add attributes needed by shader\n    const attributeManager = this.getAttributeManager()!;\n    /* eslint-disable max-len */\n    attributeManager.addInstanced({\n      instanceElevations: {\n        size: 1,\n        transition: true,\n        accessor: 'getElevation'\n      },\n      instanceFillColors: {\n        size: this.props.colorFormat.length,\n        type: GL.UNSIGNED_BYTE,\n        normalized: true,\n        transition: true,\n        accessor: 'getFillColor',\n        defaultValue: [0, 0, 0, 255]\n      },\n      instanceLineColors: {\n        size: this.props.colorFormat.length,\n        type: GL.UNSIGNED_BYTE,\n        normalized: true,\n        transition: true,\n        accessor: 'getLineColor',\n        defaultValue: [255, 255, 255, 255]\n      }\n    });\n  }\n}\n\n/** All properties supported by RasterLayer. */\nexport type RasterLayerProps<DataT = any> = _RasterLayerProps &\n  ColumnLayerProps<DataT> &\n  CompositeLayerProps;\n\n/** Properties added by RasterLayer. */\ntype _RasterLayerProps = {\n  /**\n   * Quadbin index of tile\n   */\n  tileIndex: bigint;\n};\n\n// Adapter layer around RasterColumnLayer that converts data & accessors into correct format\nexport default class RasterLayer<DataT = any, ExtraProps = {}> extends CompositeLayer<\n  Required<RasterLayerProps<DataT>> & ExtraProps\n> {\n  static layerName = 'RasterLayer';\n  static defaultProps = defaultProps;\n\n  renderLayers(): Layer | null | LayersList {\n    // Rendering props underlying layer\n    const {\n      data,\n      getElevation,\n      getFillColor,\n      getLineColor,\n      getLineWidth,\n      tileIndex,\n      updateTriggers\n    } = this.props;\n    if (!data || !tileIndex) return null;\n\n    const {blockWidth, blockHeight} = data as unknown as Raster;\n    assert(\n      blockWidth === blockHeight,\n      `blockWidth (${blockWidth}) must equal blockHeight (${blockHeight})`\n    );\n\n    const [xOffset, yOffset, scale] = quadbinToOffset(tileIndex);\n    const offset = [xOffset, yOffset, scale / blockWidth];\n\n    // Filled Column Layer\n    const CellLayer = this.getSubLayerClass('column', RasterColumnLayer);\n    return new CellLayer(\n      this.props,\n      this.getSubLayerProps({\n        id: 'cell',\n        updateTriggers,\n\n        getElevation: this.getSubLayerAccessor(getElevation),\n        getFillColor: this.getSubLayerAccessor(getFillColor),\n        getLineColor: this.getSubLayerAccessor(getLineColor),\n        getLineWidth: this.getSubLayerAccessor(getLineWidth)\n      }),\n      {\n        data: {\n          data, // Pass through data for getSubLayerAccessor()\n          length: blockWidth * blockHeight\n        },\n        offset\n      }\n    );\n  }\n\n  protected getSubLayerAccessor<In, Out>(accessor: Accessor<In, Out>): Accessor<In, Out> {\n    if (typeof accessor !== 'function') {\n      return super.getSubLayerAccessor(accessor);\n    }\n\n    // Proxy values back in standard feature format\n    return (object, info) => {\n      const {data, index} = info;\n      const binaryData = (data as unknown as {data: Raster}).data;\n      const proxy = createBinaryProxy(binaryData.cells, index);\n      // @ts-ignore (TS2349) accessor is always function\n      return accessor({properties: proxy}, info);\n    };\n  }\n}\n"],"file":"raster-layer.js"}