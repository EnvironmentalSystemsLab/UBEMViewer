{"version":3,"sources":["../../../src/layers/quadbin-tile-layer.ts"],"names":["CompositeLayer","QuadbinLayer","QuadbinTileset2D","SpatialIndexTileLayer","hexToBigInt","renderSubLayers","props","data","length","isBigInt","id","getQuadbin","d","defaultProps","aggregationResLevel","QuadbinTileLayer","initializeState","setState","tileJSON","updateState","changeFlags","dataChanged","tiles","renderLayers","state","maxZoom","parseInt","maxresolution","TilesetClass","loadOptions","getLoadOptions","cartoSpatialTile","scheme","mimeType"],"mappings":";AAAA,SACEA,cADF,QAOO,eAPP;AAQA,OAAOC,YAAP,MAA8C,iBAA9C;AACA,OAAOC,gBAAP,MAA6B,sBAA7B;AACA,OAAOC,qBAAP,MAAkC,4BAAlC;AACA,SAAQC,WAAR,QAA0B,SAA1B;AAEA,OAAO,MAAMC,eAAe,GAAGC,KAAK,IAAI;AACtC,QAAM;AAACC,IAAAA;AAAD,MAASD,KAAf;AACA,MAAI,CAACC,IAAD,IAAS,CAACA,IAAI,CAACC,MAAnB,EAA2B,OAAO,IAAP;AAC3B,QAAMC,QAAQ,GAAG,OAAOF,IAAI,CAAC,CAAD,CAAJ,CAAQG,EAAf,KAAsB,QAAvC;AACA,SAAO,IAAIT,YAAJ,CAAiBK,KAAjB,EAAwB;AAC7BK,IAAAA,UAAU,EAAEF,QAAQ,GAAGG,CAAC,IAAIA,CAAC,CAACF,EAAV,GAAeE,CAAC,IAAIR,WAAW,CAACQ,CAAC,CAACF,EAAH;AADtB,GAAxB,CAAP;AAGD,CAPM;AASP,MAAMG,YAAiD,GAAG;AACxDC,EAAAA,mBAAmB,EAAE;AADmC,CAA1D;AAcA,eAAe,MAAMC,gBAAN,SAGLf,cAHK,CAGgE;AAAA;AAAA;;AAAA;AAAA;;AAQ7EgB,EAAAA,eAAe,GAAS;AACtB,SAAKC,QAAL,CAAc;AAACV,MAAAA,IAAI,EAAE,IAAP;AAAaW,MAAAA,QAAQ,EAAE;AAAvB,KAAd;AACD;;AAEDC,EAAAA,WAAW,CAAC;AAACC,IAAAA;AAAD,GAAD,EAA8C;AACvD,QAAIA,WAAW,CAACC,WAAhB,EAA6B;AAC3B,UAAI;AAACd,QAAAA;AAAD,UAAS,KAAKD,KAAlB;AACA,YAAMY,QAAQ,GAAGX,IAAjB;AACAA,MAAAA,IAAI,GAAIW,QAAD,CAAkBI,KAAzB;AACA,WAAKL,QAAL,CAAc;AAACV,QAAAA,IAAD;AAAOW,QAAAA;AAAP,OAAd;AACD;AACF;;AAEDK,EAAAA,YAAY,GAA8B;AACxC,UAAM;AAAChB,MAAAA,IAAD;AAAOW,MAAAA;AAAP,QAAmB,KAAKM,KAA9B;AACA,UAAMC,OAAO,GAAGC,QAAQ,CAACR,QAAD,aAACA,QAAD,uBAACA,QAAQ,CAAES,aAAX,CAAxB;AACA,WAAO,CACL,IAAIxB,qBAAJ,CAA0B,KAAKG,KAA/B,EAAsC;AACpCI,MAAAA,EAAE,+BAAwB,KAAKJ,KAAL,CAAWI,EAAnC,CADkC;AAEpCH,MAAAA,IAFoC;AAIpCqB,MAAAA,YAAY,EAAE1B,gBAJsB;AAKpCG,MAAAA,eALoC;AAMpCoB,MAAAA,OANoC;AAOpCI,MAAAA,WAAW,EAAE,EACX,GAAG,KAAKC,cAAL,EADQ;AAEXC,QAAAA,gBAAgB,EAAE;AAACC,UAAAA,MAAM,EAAE;AAAT,SAFP;AAGXC,QAAAA,QAAQ,EAAE;AAHC;AAPuB,KAAtC,CADK,CAAP;AAeD;;AAvC4E;;gBAH1DlB,gB,eAIA,kB;;gBAJAA,gB,kBAKGF,Y","sourcesContent":["import {\n  CompositeLayer,\n  CompositeLayerProps,\n  Layer,\n  LayersList,\n  UpdateParameters,\n  DefaultProps\n} from '@deck.gl/core';\nimport QuadbinLayer, {QuadbinLayerProps} from './quadbin-layer';\nimport QuadbinTileset2D from './quadbin-tileset-2d';\nimport SpatialIndexTileLayer from './spatial-index-tile-layer';\nimport {hexToBigInt} from 'quadbin';\n\nexport const renderSubLayers = props => {\n  const {data} = props;\n  if (!data || !data.length) return null;\n  const isBigInt = typeof data[0].id === 'bigint';\n  return new QuadbinLayer(props, {\n    getQuadbin: isBigInt ? d => d.id : d => hexToBigInt(d.id)\n  });\n};\n\nconst defaultProps: DefaultProps<QuadbinTileLayerProps> = {\n  aggregationResLevel: 6\n};\n\n/** All properties supported by QuadbinTileLayer. */\nexport type QuadbinTileLayerProps<DataT = any> = _QuadbinTileLayerProps<DataT> &\n  CompositeLayerProps;\n\n/** Properties added by QuadbinTileLayer. */\ntype _QuadbinTileLayerProps<DataT> = QuadbinLayerProps<DataT> & {\n  data: string;\n  aggregationResLevel?: number;\n};\n\nexport default class QuadbinTileLayer<\n  DataT = any,\n  ExtraProps extends {} = {}\n> extends CompositeLayer<ExtraProps & Required<_QuadbinTileLayerProps<DataT>>> {\n  static layerName = 'QuadbinTileLayer';\n  static defaultProps = defaultProps;\n\n  state!: {\n    tileJSON: any;\n    data: any;\n  };\n  initializeState(): void {\n    this.setState({data: null, tileJSON: null});\n  }\n\n  updateState({changeFlags}: UpdateParameters<this>): void {\n    if (changeFlags.dataChanged) {\n      let {data} = this.props;\n      const tileJSON = data;\n      data = (tileJSON as any).tiles;\n      this.setState({data, tileJSON});\n    }\n  }\n\n  renderLayers(): Layer | null | LayersList {\n    const {data, tileJSON} = this.state;\n    const maxZoom = parseInt(tileJSON?.maxresolution);\n    return [\n      new SpatialIndexTileLayer(this.props, {\n        id: `quadbin-tile-layer-${this.props.id}`,\n        data,\n        // TODO: Tileset2D should be generic over TileIndex type\n        TilesetClass: QuadbinTileset2D as any,\n        renderSubLayers,\n        maxZoom,\n        loadOptions: {\n          ...this.getLoadOptions(),\n          cartoSpatialTile: {scheme: 'quadbin'},\n          mimeType: 'application/vnd.carto-spatial-tile'\n        }\n      })\n    ];\n  }\n}\n"],"file":"quadbin-tile-layer.js"}