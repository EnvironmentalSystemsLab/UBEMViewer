{"version":3,"file":"wrap.js","names":["_clip","require","_feature","_createSuper","Derived","hasNativeReflectConstruct","_isNativeReflectConstruct","_createSuperInternal","Super","_getPrototypeOf2","default","result","NewTarget","constructor","Reflect","construct","arguments","apply","_possibleConstructorReturn2","sham","Proxy","Boolean","prototype","valueOf","call","e","_createForOfIteratorHelper","o","allowArrayLike","it","Symbol","iterator","Array","isArray","_unsupportedIterableToArray","length","i","F","s","n","done","value","_e","f","TypeError","normalCompletion","didErr","err","step","next","_e2","return","minLen","_arrayLikeToArray","Object","toString","slice","name","from","test","arr","len","arr2","wrap","features","options","buffer","extent","merged","left","clip","right","shiftFeatureCoords","concat","offset","newFeatures","feature","type","newGeometry","shiftCoords","geometry","_iterator","_step","line","push","_iterator2","_step2","polygon","newPolygon","_iterator3","_step3","createFeature","id","tags","Points","_Array","_inherits2","_super","_this","_classCallCheck2","_len","args","_key","_defineProperty2","_assertThisInitialized2","_createClass2","_wrapNativeSuper2","points","newPoints","size","start","undefined","end"],"sources":["../../../../src/lib/geojson-tiler/wrap.ts"],"sourcesContent":["// loaders.gl, MIT license\n// Forked from https://github.com/mapbox/geojson-vt under compatible ISC license\n\nimport type {GeoJSONTileFeature} from './tile';\nimport {clip} from './clip';\nimport {createFeature} from './feature';\n\n/**\n * Options for wrap()\n */\nexport type WrapOptions = {\n  buffer: number /** number of pixels of buffer for the tile */;\n  extent: number /** extent of each tile */;\n  lineMetrics: boolean;\n};\n\n/**\n * Wrap across antemeridian, by clipping into two tiles, shifting the overflowing x coordinates\n * @param features list of features to be wrapped\n * @param options buffer and extent\n * @returns\n */\nexport function wrap(features: GeoJSONTileFeature[], options: WrapOptions) {\n  const buffer = options.buffer / options.extent;\n  let merged: GeoJSONTileFeature[] = features;\n  const left = clip(features, 1, -1 - buffer, buffer, 0, -1, 2, options); // left world copy\n  const right = clip(features, 1, 1 - buffer, 2 + buffer, 0, -1, 2, options); // right world copy\n\n  if (left || right) {\n    merged = clip(features, 1, -buffer, 1 + buffer, 0, -1, 2, options) || []; // center world copy\n\n    if (left) {\n      merged = shiftFeatureCoords(left, 1).concat(merged); // merge left into center\n    }\n    if (right) {\n      merged = merged.concat(shiftFeatureCoords(right, -1)); // merge right into center\n    }\n  }\n\n  return merged;\n}\n\n/**\n * Shift the x coordinates of a list of features\n * @param features list of features to shift x coordinates for\n * @param offset\n * @returns\n */\nfunction shiftFeatureCoords(features: GeoJSONTileFeature[], offset: number): GeoJSONTileFeature[] {\n  const newFeatures: GeoJSONTileFeature[] = [];\n\n  for (let i = 0; i < features.length; i++) {\n    const feature = features[i];\n    const type = feature.type;\n\n    let newGeometry;\n\n    if (type === 'Point' || type === 'MultiPoint' || type === 'LineString') {\n      newGeometry = shiftCoords(feature.geometry, offset);\n    } else if (type === 'MultiLineString' || type === 'Polygon') {\n      newGeometry = [];\n      for (const line of feature.geometry) {\n        newGeometry.push(shiftCoords(line, offset));\n      }\n    } else if (type === 'MultiPolygon') {\n      newGeometry = [];\n      for (const polygon of feature.geometry) {\n        const newPolygon: Points = [];\n        for (const line of polygon) {\n          // @ts-expect-error TODO\n          newPolygon.push(shiftCoords(line, offset));\n        }\n        newGeometry.push(newPolygon);\n      }\n    }\n\n    newFeatures.push(createFeature(feature.id, type, newGeometry, feature.tags));\n  }\n\n  return newFeatures;\n}\n\nclass Points extends Array<number> {\n  size?: number;\n  start?: number;\n  end?: number;\n}\n\n/**\n * Shift the x coordinate of every point\n * @param points\n * @param offset\n * @returns\n */\nfunction shiftCoords(points: Points, offset: number): Points {\n  const newPoints: Points = [];\n  newPoints.size = points.size;\n\n  if (points.start !== undefined) {\n    newPoints.start = points.start;\n    newPoints.end = points.end;\n  }\n\n  for (let i = 0; i < points.length; i += 3) {\n    newPoints.push(points[i] + offset, points[i + 1], points[i + 2]);\n  }\n  return newPoints;\n}\n"],"mappings":"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"}