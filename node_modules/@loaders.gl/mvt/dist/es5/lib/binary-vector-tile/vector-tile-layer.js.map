{"version":3,"file":"vector-tile-layer.js","names":["_vectorTileFeature","_interopRequireDefault","require","VectorTileLayer","pbf","end","_classCallCheck2","default","_defineProperty2","version","name","extent","length","_pbf","_keys","_values","_features","readFields","readLayer","_createClass2","key","value","feature","i","geometryInfo","Error","pos","readVarint","VectorTileFeature","exports","tag","layer","readString","push","readValueMessage","readFloat","readDouble","readVarint64","readSVarint","readBoolean"],"sources":["../../../../src/lib/binary-vector-tile/vector-tile-layer.ts"],"sourcesContent":["/* eslint-disable indent */\n// This code is forked from https://github.com/mapbox/vector-tile-js under BSD 3-clause license.\n\nimport VectorTileFeature from './vector-tile-feature';\nimport Protobuf from 'pbf';\nimport {GeojsonGeometryInfo} from '@loaders.gl/schema';\n\nexport default class VectorTileLayer {\n  version: number;\n  name: string;\n  extent: number;\n  length: number;\n  _pbf: Protobuf;\n  _keys: string[];\n  _values: (string | number | boolean | null)[];\n  _features: number[];\n  constructor(pbf: Protobuf, end: number) {\n    // Public\n    this.version = 1;\n    this.name = '';\n    this.extent = 4096;\n    this.length = 0;\n\n    // Private\n    this._pbf = pbf;\n    this._keys = [];\n    this._values = [];\n    this._features = [];\n\n    pbf.readFields(readLayer, this, end);\n\n    this.length = this._features.length;\n  }\n\n  /**\n   * return feature `i` from this layer as a `VectorTileFeature`\n   *\n   * @param index\n   * @param geometryInfo\n   * @returns {VectorTileFeature}\n   */\n  feature(i: number, geometryInfo: GeojsonGeometryInfo): VectorTileFeature {\n    if (i < 0 || i >= this._features.length) {\n      throw new Error('feature index out of bounds');\n    }\n\n    this._pbf.pos = this._features[i];\n\n    const end = this._pbf.readVarint() + this._pbf.pos;\n    return new VectorTileFeature(\n      this._pbf,\n      end,\n      this.extent,\n      this._keys,\n      this._values,\n      geometryInfo\n    );\n  }\n}\n\n/**\n *\n * @param tag\n * @param layer\n * @param pbf\n */\nfunction readLayer(tag: number, layer?: VectorTileLayer, pbf?: Protobuf): void {\n  if (layer && pbf) {\n    if (tag === 15) layer.version = pbf.readVarint();\n    else if (tag === 1) layer.name = pbf.readString();\n    else if (tag === 5) layer.extent = pbf.readVarint();\n    else if (tag === 2) layer._features.push(pbf.pos);\n    else if (tag === 3) layer._keys.push(pbf.readString());\n    else if (tag === 4) layer._values.push(readValueMessage(pbf));\n  }\n}\n\n/**\n *\n * @param pbf\n * @returns value\n */\nfunction readValueMessage(pbf: Protobuf) {\n  let value: string | number | boolean | null = null;\n  const end = pbf.readVarint() + pbf.pos;\n\n  while (pbf.pos < end) {\n    const tag = pbf.readVarint() >> 3;\n\n    value =\n      tag === 1\n        ? pbf.readString()\n        : tag === 2\n        ? pbf.readFloat()\n        : tag === 3\n        ? pbf.readDouble()\n        : tag === 4\n        ? pbf.readVarint64()\n        : tag === 5\n        ? pbf.readVarint()\n        : tag === 6\n        ? pbf.readSVarint()\n        : tag === 7\n        ? pbf.readBoolean()\n        : null;\n  }\n\n  return value;\n}\n"],"mappings":"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"}