{"version":3,"file":"skirt.js","names":["_loaderUtils","require","addSkirt","attributes","triangles","skirtHeight","outsideIndices","outsideEdges","getOutsideEdgesFromIndices","POSITION","value","getOutsideEdgesFromTriangles","newPosition","constructor","length","newTexcoord0","TEXCOORD_0","newTriangles","i","edge","updateAttributesForNewEdge","edgeIndex","concatenateTypedArrays","resultTriangles","Array","concat","edges","push","sort","a","b","Math","min","apply","_toConsumableArray2","default","max","index","_edges","_edges2","indices","position","westIndices","eastIndices","southIndices","northIndices","indexGroup","_ref","positionsLength","vertex1Offset","vertex2Offset","set","subarray","triangle1Offset"],"sources":["../../../../src/lib/helpers/skirt.ts"],"sourcesContent":["import {concatenateTypedArrays} from '@loaders.gl/loader-utils';\n\nexport type EdgeIndices = {\n  westIndices: number[];\n  northIndices: number[];\n  eastIndices: number[];\n  southIndices: number[];\n};\n\n/**\n * Add skirt to existing mesh\n * @param {object} attributes - POSITION and TEXCOOD_0 attributes data\n * @param {any} triangles - indices array of the mesh geometry\n * @param skirtHeight - height of the skirt geometry\n * @param outsideIndices - edge indices from quantized mesh data\n * @returns - geometry data with added skirt\n */\nexport function addSkirt(attributes, triangles, skirtHeight: number, outsideIndices?: EdgeIndices) {\n  const outsideEdges = outsideIndices\n    ? getOutsideEdgesFromIndices(outsideIndices, attributes.POSITION.value)\n    : getOutsideEdgesFromTriangles(triangles);\n\n  // 2 new vertices for each outside edge\n  const newPosition = new attributes.POSITION.value.constructor(outsideEdges.length * 6);\n  const newTexcoord0 = new attributes.TEXCOORD_0.value.constructor(outsideEdges.length * 4);\n\n  // 2 new triangles for each outside edge\n  const newTriangles = new triangles.constructor(outsideEdges.length * 6);\n\n  for (let i = 0; i < outsideEdges.length; i++) {\n    const edge = outsideEdges[i];\n\n    updateAttributesForNewEdge({\n      edge,\n      edgeIndex: i,\n      attributes,\n      skirtHeight,\n      newPosition,\n      newTexcoord0,\n      newTriangles\n    });\n  }\n\n  attributes.POSITION.value = concatenateTypedArrays(attributes.POSITION.value, newPosition);\n  attributes.TEXCOORD_0.value = concatenateTypedArrays(attributes.TEXCOORD_0.value, newTexcoord0);\n  const resultTriangles =\n    triangles instanceof Array\n      ? triangles.concat(newTriangles)\n      : concatenateTypedArrays(triangles, newTriangles);\n\n  return {\n    attributes,\n    triangles: resultTriangles\n  };\n}\n\n/**\n * Get geometry edges that located on a border of the mesh\n * @param {any} triangles - indices array of the mesh geometry\n * @returns {number[][]} - outside edges data\n */\nfunction getOutsideEdgesFromTriangles(triangles) {\n  const edges: number[][] = [];\n  for (let i = 0; i < triangles.length; i += 3) {\n    edges.push([triangles[i], triangles[i + 1]]);\n    edges.push([triangles[i + 1], triangles[i + 2]]);\n    edges.push([triangles[i + 2], triangles[i]]);\n  }\n\n  edges.sort((a, b) => Math.min(...a) - Math.min(...b) || Math.max(...a) - Math.max(...b));\n\n  const outsideEdges: number[][] = [];\n  let index = 0;\n  while (index < edges.length) {\n    if (edges[index][0] === edges[index + 1]?.[1] && edges[index][1] === edges[index + 1]?.[0]) {\n      index += 2;\n    } else {\n      outsideEdges.push(edges[index]);\n      index++;\n    }\n  }\n  return outsideEdges;\n}\n\n/**\n * Get geometry edges that located on a border of the mesh\n * @param {object} indices - edge indices from quantized mesh data\n * @param {TypedArray} position - position attribute geometry data\n * @returns {number[][]} - outside edges data\n */\nfunction getOutsideEdgesFromIndices(indices: EdgeIndices, position) {\n  // Sort skirt indices to create adjacent triangles\n  indices.westIndices.sort((a, b) => position[3 * a + 1] - position[3 * b + 1]);\n  // Reverse (b - a) to match triangle winding\n  indices.eastIndices.sort((a, b) => position[3 * b + 1] - position[3 * a + 1]);\n  indices.southIndices.sort((a, b) => position[3 * b] - position[3 * a]);\n  // Reverse (b - a) to match triangle winding\n  indices.northIndices.sort((a, b) => position[3 * a] - position[3 * b]);\n\n  const edges: number[][] = [];\n  for (const index in indices) {\n    const indexGroup = indices[index];\n    for (let i = 0; i < indexGroup.length - 1; i++) {\n      edges.push([indexGroup[i], indexGroup[i + 1]]);\n    }\n  }\n  return edges;\n}\n\n/**\n * Get geometry edges that located on a border of the mesh\n * @param {object} args\n * @param {number[]} args.edge - edge indices in geometry\n * @param {number} args.edgeIndex - edge index in outsideEdges array\n * @param {object} args.attributes - POSITION and TEXCOORD_0 attributes\n * @param {number} args.skirtHeight - height of the skirt geometry\n * @param {TypedArray} args.newPosition - POSITION array for skirt data\n * @param {TypedArray} args.newTexcoord0 - TEXCOORD_0 array for skirt data\n * @param {TypedArray | Array} args.newTriangles - trinagle indices array for skirt data\n * @returns {void}\n */\nfunction updateAttributesForNewEdge({\n  edge,\n  edgeIndex,\n  attributes,\n  skirtHeight,\n  newPosition,\n  newTexcoord0,\n  newTriangles\n}) {\n  const positionsLength = attributes.POSITION.value.length;\n  const vertex1Offset = edgeIndex * 2;\n  const vertex2Offset = edgeIndex * 2 + 1;\n\n  // Define POSITION for new 1st vertex\n  newPosition.set(\n    attributes.POSITION.value.subarray(edge[0] * 3, edge[0] * 3 + 3),\n    vertex1Offset * 3\n  );\n  newPosition[vertex1Offset * 3 + 2] = newPosition[vertex1Offset * 3 + 2] - skirtHeight; // put down elevation on the skirt height\n\n  // Define POSITION for new 2nd vertex\n  newPosition.set(\n    attributes.POSITION.value.subarray(edge[1] * 3, edge[1] * 3 + 3),\n    vertex2Offset * 3\n  );\n  newPosition[vertex2Offset * 3 + 2] = newPosition[vertex2Offset * 3 + 2] - skirtHeight; // put down elevation on the skirt height\n\n  // Use same TEXCOORDS for skirt vertices\n  newTexcoord0.set(\n    attributes.TEXCOORD_0.value.subarray(edge[0] * 2, edge[0] * 2 + 2),\n    vertex1Offset * 2\n  );\n  newTexcoord0.set(\n    attributes.TEXCOORD_0.value.subarray(edge[1] * 2, edge[1] * 2 + 2),\n    vertex2Offset * 2\n  );\n\n  // Define new triangles\n  const triangle1Offset = edgeIndex * 2 * 3;\n  newTriangles[triangle1Offset] = edge[0];\n  newTriangles[triangle1Offset + 1] = positionsLength / 3 + vertex2Offset;\n  newTriangles[triangle1Offset + 2] = edge[1];\n\n  newTriangles[triangle1Offset + 3] = positionsLength / 3 + vertex2Offset;\n  newTriangles[triangle1Offset + 4] = edge[0];\n  newTriangles[triangle1Offset + 5] = positionsLength / 3 + vertex1Offset;\n}\n"],"mappings":"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"}