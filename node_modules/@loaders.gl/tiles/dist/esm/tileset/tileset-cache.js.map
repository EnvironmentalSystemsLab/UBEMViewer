{"version":3,"file":"tileset-cache.js","names":["DoublyLinkedList","TilesetCache","constructor","_defineProperty","_list","_sentinel","add","_trimTiles","reset","splice","tail","touch","tile","node","_cacheNode","tileset","addCallback","unloadTile","unloadCallback","remove","unloadTiles","trimTiles","list","maximumMemoryUsageInBytes","maximumMemoryUsage","sentinel","head","gpuMemoryUsageInBytes","item","next","trim"],"sources":["../../../src/tileset/tileset-cache.ts"],"sourcesContent":["// loaders.gl, MIT license\n\n// This file is derived from the Cesium code base under Apache 2 license\n// See LICENSE.md and https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md\n\nimport type {Tileset3D} from './tileset-3d';\nimport type {Tile3D} from './tile-3d';\nimport {DoublyLinkedList} from '../utils/doubly-linked-list';\n\n/**\n * Stores tiles with content loaded.\n * @private\n */\nexport class TilesetCache {\n  private _list: DoublyLinkedList;\n  private _sentinel: any;\n  private _trimTiles: boolean;\n\n  constructor() {\n    // [head, sentinel) -> tiles that weren't selected this frame and may be removed from the cache\n    // (sentinel, tail] -> tiles that were selected this frame\n    this._list = new DoublyLinkedList();\n    this._sentinel = this._list.add('sentinel');\n    this._trimTiles = false;\n  }\n\n  reset(): void {\n    // Move sentinel node to the tail so, at the start of the frame, all tiles\n    // may be potentially replaced.  Tiles are moved to the right of the sentinel\n    // when they are selected so they will not be replaced.\n    this._list.splice(this._list.tail, this._sentinel);\n  }\n\n  touch(tile: Tile3D): void {\n    const node = tile._cacheNode;\n    if (node) {\n      this._list.splice(this._sentinel, node);\n    }\n  }\n\n  add(\n    tileset: Tileset3D,\n    tile: Tile3D,\n    addCallback?: (tileset: Tileset3D, tile: Tile3D) => void\n  ): void {\n    if (!tile._cacheNode) {\n      tile._cacheNode = this._list.add(tile);\n\n      if (addCallback) {\n        addCallback(tileset, tile);\n      }\n    }\n  }\n\n  unloadTile(\n    tileset: Tileset3D,\n    tile: Tile3D,\n    unloadCallback?: (tileset: Tileset3D, tile: Tile3D) => void\n  ): void {\n    const node = tile._cacheNode;\n    if (!node) {\n      return;\n    }\n\n    this._list.remove(node);\n    tile._cacheNode = null;\n    if (unloadCallback) {\n      unloadCallback(tileset, tile);\n    }\n  }\n\n  unloadTiles(tileset, unloadCallback): void {\n    const trimTiles = this._trimTiles;\n    this._trimTiles = false;\n\n    const list = this._list;\n\n    const maximumMemoryUsageInBytes = tileset.maximumMemoryUsage * 1024 * 1024;\n\n    // Traverse the list only to the sentinel since tiles/nodes to the\n    // right of the sentinel were used this frame.\n    // The sub-list to the left of the sentinel is ordered from LRU to MRU.\n    const sentinel = this._sentinel;\n    let node = list.head;\n\n    while (\n      node !== sentinel &&\n      (tileset.gpuMemoryUsageInBytes > maximumMemoryUsageInBytes || trimTiles)\n    ) {\n      // @ts-expect-error\n      const tile = node.item;\n      // @ts-expect-error\n      node = node.next;\n      this.unloadTile(tileset, tile, unloadCallback);\n    }\n  }\n\n  trim(): void {\n    this._trimTiles = true;\n  }\n}\n"],"mappings":";AAOA,SAAQA,gBAAgB,QAAO,6BAA6B;AAM5D,OAAO,MAAMC,YAAY,CAAC;EAKxBC,WAAWA,CAAA,EAAG;IAAAC,eAAA;IAAAA,eAAA;IAAAA,eAAA;IAGZ,IAAI,CAACC,KAAK,GAAG,IAAIJ,gBAAgB,CAAC,CAAC;IACnC,IAAI,CAACK,SAAS,GAAG,IAAI,CAACD,KAAK,CAACE,GAAG,CAAC,UAAU,CAAC;IAC3C,IAAI,CAACC,UAAU,GAAG,KAAK;EACzB;EAEAC,KAAKA,CAAA,EAAS;IAIZ,IAAI,CAACJ,KAAK,CAACK,MAAM,CAAC,IAAI,CAACL,KAAK,CAACM,IAAI,EAAE,IAAI,CAACL,SAAS,CAAC;EACpD;EAEAM,KAAKA,CAACC,IAAY,EAAQ;IACxB,MAAMC,IAAI,GAAGD,IAAI,CAACE,UAAU;IAC5B,IAAID,IAAI,EAAE;MACR,IAAI,CAACT,KAAK,CAACK,MAAM,CAAC,IAAI,CAACJ,SAAS,EAAEQ,IAAI,CAAC;IACzC;EACF;EAEAP,GAAGA,CACDS,OAAkB,EAClBH,IAAY,EACZI,WAAwD,EAClD;IACN,IAAI,CAACJ,IAAI,CAACE,UAAU,EAAE;MACpBF,IAAI,CAACE,UAAU,GAAG,IAAI,CAACV,KAAK,CAACE,GAAG,CAACM,IAAI,CAAC;MAEtC,IAAII,WAAW,EAAE;QACfA,WAAW,CAACD,OAAO,EAAEH,IAAI,CAAC;MAC5B;IACF;EACF;EAEAK,UAAUA,CACRF,OAAkB,EAClBH,IAAY,EACZM,cAA2D,EACrD;IACN,MAAML,IAAI,GAAGD,IAAI,CAACE,UAAU;IAC5B,IAAI,CAACD,IAAI,EAAE;MACT;IACF;IAEA,IAAI,CAACT,KAAK,CAACe,MAAM,CAACN,IAAI,CAAC;IACvBD,IAAI,CAACE,UAAU,GAAG,IAAI;IACtB,IAAII,cAAc,EAAE;MAClBA,cAAc,CAACH,OAAO,EAAEH,IAAI,CAAC;IAC/B;EACF;EAEAQ,WAAWA,CAACL,OAAO,EAAEG,cAAc,EAAQ;IACzC,MAAMG,SAAS,GAAG,IAAI,CAACd,UAAU;IACjC,IAAI,CAACA,UAAU,GAAG,KAAK;IAEvB,MAAMe,IAAI,GAAG,IAAI,CAAClB,KAAK;IAEvB,MAAMmB,yBAAyB,GAAGR,OAAO,CAACS,kBAAkB,GAAG,IAAI,GAAG,IAAI;IAK1E,MAAMC,QAAQ,GAAG,IAAI,CAACpB,SAAS;IAC/B,IAAIQ,IAAI,GAAGS,IAAI,CAACI,IAAI;IAEpB,OACEb,IAAI,KAAKY,QAAQ,KAChBV,OAAO,CAACY,qBAAqB,GAAGJ,yBAAyB,IAAIF,SAAS,CAAC,EACxE;MAEA,MAAMT,IAAI,GAAGC,IAAI,CAACe,IAAI;MAEtBf,IAAI,GAAGA,IAAI,CAACgB,IAAI;MAChB,IAAI,CAACZ,UAAU,CAACF,OAAO,EAAEH,IAAI,EAAEM,cAAc,CAAC;IAChD;EACF;EAEAY,IAAIA,CAAA,EAAS;IACX,IAAI,CAACvB,UAAU,GAAG,IAAI;EACxB;AACF"}