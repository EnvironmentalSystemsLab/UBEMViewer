{"version":3,"file":"csw-service.js","names":["DataSource","CSWCapabilitiesLoader","CSWRecordsLoader","CSWDomainLoader","WMSErrorLoader","CSWErrorLoader","CSWService","constructor","props","_defineProperty","getMetadata","capabilities","getCapabilities","normalizeMetadata","getServiceDirectory","options","services","unknownServices","records","getRecords","record","reference","references","url","value","scheme","push","name","title","type","_parseOGCUrl","includeUnknown","concat","parts","split","params","wmsParameters","vendorParameters","getCapabilitiesURL","response","fetch","arrayBuffer","_checkResponse","parse","loadOptions","getRecordsURL","getDomain","getDomainURL","version","service","request","_getCSWUrl","typenames","first","key","Object","entries","Array","isArray","toUpperCase","join","String","encodeURI","contentType","headers","ok","mimeTypes","includes","error","parseSync","Error","_parseError","toLowerCase"],"sources":["../../../../../src/lib/services/ogc/csw-service.ts"],"sourcesContent":["// loaders.gl, MIT license\n\n/* eslint-disable camelcase */\n\nimport type {DataSourceProps} from '../../sources/data-source';\nimport {DataSource} from '../../sources/data-source';\n\nimport type {CSWCapabilities} from '../../../csw-capabilities-loader';\nimport {CSWCapabilitiesLoader} from '../../../csw-capabilities-loader';\n\nimport type {CSWRecords} from '../../../csw-records-loader';\nimport {CSWRecordsLoader} from '../../../csw-records-loader';\n\nimport type {CSWDomain} from '../../../csw-domain-loader';\nimport {CSWDomainLoader} from '../../../csw-domain-loader';\n\nimport {WMSErrorLoader as CSWErrorLoader} from '../../../wms-error-loader';\n\ntype CSWCommonParameters = {\n  /** In case the endpoint supports multiple services */\n  service?: 'CSW';\n  /** In case the endpoint supports multiple CSW versions */\n  version?: '1.1.1' | '2.0.0' | '2.0.1' | '3.0.0';\n};\n\nexport type CSWGetCapabilitiesParameters = CSWCommonParameters & {\n  /** Request type */\n  request?: 'GetCapabilities';\n};\n\nexport type CSWGetRecordsParameters = CSWCommonParameters & {\n  /** Request type */\n  request?: 'GetRecords';\n  /** type of records */\n  typenames: 'csw:Record';\n};\n\nexport type CSWGetDomainParameters = CSWCommonParameters & {\n  /** Request type */\n  request?: 'GetDomain';\n  // TBA\n};\n\n/** Describes a service or resource exposed by the catalog */\nexport type Service = {\n  /** name of service or resource */\n  name: string;\n  /** type of service or resource */\n  type: string;\n  url: string;\n  params?: string;\n  scheme?: string;\n};\n\nexport type CSWServiceProps = DataSourceProps & {\n  url: string;\n};\n\n/**\n * The CSWService class\n * - provides type safe methods to form URLs to a CSW service\n * - provides type safe methods to query and parse results (and errors) from a CSW service\n * @note Only the URL parameter conversion is supported. XML posts are not supported.\n */\nexport class CSWService extends DataSource<CSWServiceProps> {\n  static type: 'csw' = 'csw';\n  static testURL = (url: string): boolean => url.toLowerCase().includes('csw');\n\n  capabilities: CSWCapabilities | null = null;\n\n  /** A list of loaders used by the CSWService methods */\n  readonly loaders = [CSWErrorLoader, CSWCapabilitiesLoader];\n\n  /** Create a CSWService */\n  constructor(props: CSWServiceProps) {\n    super(props);\n  }\n\n  async getMetadata(): Promise<CSWCapabilities> {\n    const capabilities = await this.getCapabilities();\n    return this.normalizeMetadata(capabilities);\n  }\n\n  normalizeMetadata(capabilities: CSWCapabilities): CSWCapabilities {\n    return capabilities;\n  }\n\n  async getServiceDirectory(options?: {includeUnknown?: boolean}): Promise<Service[]> {\n    const services: Service[] = [];\n    const unknownServices: Service[] = [];\n\n    const records = await this.getRecords();\n    for (const record of records.records) {\n      for (const reference of record.references) {\n        const url = reference.value;\n        switch (reference.scheme) {\n          case 'OGC:WMS':\n            services.push({name: record.title, type: 'ogc-wms-service', ...this._parseOGCUrl(url)});\n            break;\n          case 'OGC:WMTS':\n            services.push({\n              name: record.title,\n              type: 'ogc-wmts-service',\n              ...this._parseOGCUrl(url)\n            });\n            break;\n          case 'OGC:WFS':\n            services.push({name: record.title, type: 'ogc-wfs-service', ...this._parseOGCUrl(url)});\n            break;\n          default:\n            unknownServices.push({\n              name: record.title,\n              type: 'unknown',\n              url: reference.value,\n              scheme: reference.scheme\n            });\n        }\n      }\n    }\n\n    return options?.includeUnknown ? services.concat(unknownServices) : services;\n  }\n\n  _parseOGCUrl(url: string): {url: string; params: string} {\n    const parts = url.split('?');\n    return {\n      url: parts[0],\n      params: parts[1] || ''\n    };\n  }\n\n  // CSW Service API Stubs\n\n  /** Get Capabilities */\n  async getCapabilities(\n    wmsParameters?: CSWGetCapabilitiesParameters,\n    vendorParameters?: Record<string, unknown>\n  ): Promise<CSWCapabilities> {\n    const url = this.getCapabilitiesURL(wmsParameters, vendorParameters);\n    const response = await this.fetch(url);\n    const arrayBuffer = await response.arrayBuffer();\n    this._checkResponse(response, arrayBuffer);\n    const capabilities = await CSWCapabilitiesLoader.parse(arrayBuffer, this.props.loadOptions);\n    return capabilities;\n  }\n\n  /** Get Records */\n  async getRecords(\n    wmsParameters?: CSWGetRecordsParameters,\n    vendorParameters?: Record<string, unknown>\n  ): Promise<CSWRecords> {\n    const url = this.getRecordsURL(wmsParameters, vendorParameters);\n    const response = await this.fetch(url);\n    const arrayBuffer = await response.arrayBuffer();\n    this._checkResponse(response, arrayBuffer);\n    return await CSWRecordsLoader.parse(arrayBuffer, this.props.loadOptions);\n  }\n\n  /** Get Domain */\n  async getDomain(\n    wmsParameters?: CSWGetDomainParameters,\n    vendorParameters?: Record<string, unknown>\n  ): Promise<CSWDomain> {\n    const url = this.getDomainURL(wmsParameters, vendorParameters);\n    const response = await this.fetch(url);\n    const arrayBuffer = await response.arrayBuffer();\n    this._checkResponse(response, arrayBuffer);\n    return await CSWDomainLoader.parse(arrayBuffer, this.props.loadOptions);\n  }\n\n  // Typed URL creators\n  // For applications that want full control of fetching and parsing\n\n  /** Generate a URL for the GetCapabilities request */\n  getCapabilitiesURL(\n    wmsParameters?: CSWGetCapabilitiesParameters,\n    vendorParameters?: Record<string, unknown>\n  ): string {\n    const options: Required<CSWGetCapabilitiesParameters> = {\n      version: '3.0.0',\n      ...wmsParameters,\n      ...vendorParameters,\n      service: 'CSW',\n      request: 'GetCapabilities'\n    };\n    return this._getCSWUrl(options, vendorParameters);\n  }\n\n  /** Generate a URL for the GetCapabilities request */\n  getRecordsURL(\n    wmsParameters?: CSWGetRecordsParameters,\n    vendorParameters?: Record<string, unknown>\n  ): string {\n    const options: Required<CSWGetRecordsParameters> = {\n      version: '3.0.0',\n      typenames: 'csw:Record',\n      ...wmsParameters,\n      ...vendorParameters,\n      service: 'CSW',\n      request: 'GetRecords'\n    };\n    return this._getCSWUrl(options, vendorParameters);\n  }\n\n  /** Generate a URL for the GetCapabilities request */\n  getDomainURL(\n    wmsParameters?: CSWGetDomainParameters,\n    vendorParameters?: Record<string, unknown>\n  ): string {\n    const options: Required<CSWGetDomainParameters> = {\n      version: '3.0.0',\n      ...wmsParameters,\n      ...vendorParameters,\n      service: 'CSW',\n      request: 'GetDomain'\n    };\n    return this._getCSWUrl(options, vendorParameters);\n  }\n\n  // INTERNAL METHODS\n\n  /**\n   * @note case _getCSWUrl may need to be overridden to handle certain backends?\n   * */\n  protected _getCSWUrl(\n    options: Record<string, unknown>,\n    vendorParameters?: Record<string, unknown>\n  ): string {\n    let url = this.props.url;\n    let first = true;\n    for (const [key, value] of Object.entries(options)) {\n      url += first ? '?' : '&';\n      first = false;\n      if (Array.isArray(value)) {\n        url += `${key.toUpperCase()}=${value.join(',')}`;\n      } else {\n        url += `${key.toUpperCase()}=${value ? String(value) : ''}`;\n      }\n    }\n    return encodeURI(url);\n  }\n\n  /** Checks for and parses a CSW XML formatted ServiceError and throws an exception */\n  protected _checkResponse(response: Response, arrayBuffer: ArrayBuffer): void {\n    const contentType = response.headers['content-type'];\n    if (!response.ok || CSWErrorLoader.mimeTypes.includes(contentType)) {\n      const error = CSWErrorLoader.parseSync(arrayBuffer, this.props.loadOptions);\n      throw new Error(error);\n    }\n  }\n\n  /** Error situation detected */\n  protected _parseError(arrayBuffer: ArrayBuffer): Error {\n    const error = CSWErrorLoader.parseSync(arrayBuffer, this.props.loadOptions);\n    return new Error(error);\n  }\n}\n"],"mappings":"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"}