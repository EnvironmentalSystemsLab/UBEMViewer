{"version":3,"file":"tile-3d-batch-table.js","names":["assert","createTypedArrayFromAccessor","initializeHierarchy","traverseHierarchy","defined","x","undefined","clone","y","IGNORED_PROPERTY_FIELDS","HIERARCHY","extensions","extras","Tile3DBatchTableParser","constructor","json","binary","featureCount","_this$json","options","arguments","length","_defineProperty","_extensions","_properties","propertyName","_binaryProperties","_initializeBinaryProperties","_hierarchy","getExtension","extensionName","memorySizeInBytes","isClass","batchId","className","_checkBatchId","result","hierarchy","instanceIndex","classId","classIds","instanceClass","classes","name","isExactClass","getExactClassName","hasProperty","_hasPropertyInHierarchy","getPropertyNames","results","propertyNames","Object","keys","push","_getPropertyNamesInHierarchy","getProperty","binaryProperty","_getBinaryProperty","propertyValues","hierarchyProperty","_getHierarchyProperty","setProperty","value","_setBinaryProperty","_setHierarchyProperty","Array","valid","Error","index","unpack","typedArray","pack","binaryProperties","property","_initializeBinaryProperty","tile3DAccessor","concat","type","accessor","buffer","byteOffset","values","componentCount","size","unpacker","packer","instances","hasOwnProperty","indexOf","indexInClass","classIndexes","batchTable"],"sources":["../../../../src/lib/classes/tile-3d-batch-table.ts"],"sourcesContent":["// This file is derived from the Cesium code base under Apache 2 license\n// See LICENSE.md and https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md\n\nimport {assert} from '@loaders.gl/loader-utils';\n\nimport {createTypedArrayFromAccessor} from './helpers/tile-3d-accessor-utils';\nimport {initializeHierarchy, traverseHierarchy} from './tile-3d-batch-table-hierarchy';\n\nfunction defined(x) {\n  return x !== undefined && x !== null;\n}\n\nconst clone = (x, y) => x;\n\n// These top level fields in the batch table json are not properties\nconst IGNORED_PROPERTY_FIELDS = {\n  HIERARCHY: true, // Deprecated HIERARCHY property\n  extensions: true,\n  extras: true\n};\n\n// The size of this array equals the maximum instance count among all loaded tiles, which has the potential to be large.\nexport default class Tile3DBatchTableParser {\n  json;\n  binary;\n  featureCount;\n  _extensions;\n  // Copy all top-level property fields from the json object, ignoring special fields\n  _properties;\n  _binaryProperties;\n  // TODO: hierarchy support is only partially implemented and not tested\n  _hierarchy;\n\n  constructor(json, binary, featureCount, options = {}) {\n    assert(featureCount >= 0);\n    this.json = json || {};\n    this.binary = binary;\n    this.featureCount = featureCount;\n\n    this._extensions = this.json?.extensions || {};\n\n    // Copy all top-level property fields from the json object, ignoring special fields\n    this._properties = {};\n    for (const propertyName in this.json) {\n      if (!IGNORED_PROPERTY_FIELDS[propertyName]) {\n        this._properties[propertyName] = this.json[propertyName];\n      }\n    }\n\n    this._binaryProperties = this._initializeBinaryProperties();\n\n    // TODO: hierarchy support is only partially implemented and not tested\n    if (options['3DTILES_batch_table_hierarchy']) {\n      this._hierarchy = initializeHierarchy(this, this.json, this.binary);\n    }\n  }\n\n  getExtension(extensionName) {\n    return this.json && this.json.extensions && this.json.extensions[extensionName];\n  }\n\n  memorySizeInBytes(): number {\n    return 0;\n  }\n\n  isClass(batchId, className: string): boolean {\n    this._checkBatchId(batchId);\n    assert(typeof className === 'string', className);\n\n    // extension: 3DTILES_batch_table_hierarchy\n    if (this._hierarchy) {\n      // PERFORMANCE_IDEA : cache results in the ancestor classes\n      //   to speed up this check if this area becomes a hotspot\n      // PERFORMANCE_IDEA : treat class names as integers for faster comparisons\n      const result = traverseHierarchy(this._hierarchy, batchId, (hierarchy, instanceIndex) => {\n        const classId = hierarchy.classIds[instanceIndex];\n        const instanceClass = hierarchy.classes[classId];\n        return instanceClass.name === className;\n      });\n      return defined(result);\n    }\n\n    return false;\n  }\n\n  isExactClass(batchId, className) {\n    assert(typeof className === 'string', className);\n\n    return this.getExactClassName(batchId) === className;\n  }\n\n  getExactClassName(batchId) {\n    this._checkBatchId(batchId);\n\n    // extension: 3DTILES_batch_table_hierarchy\n    if (this._hierarchy) {\n      const classId = this._hierarchy.classIds[batchId];\n      const instanceClass = this._hierarchy.classes[classId];\n      return instanceClass.name;\n    }\n\n    return undefined;\n  }\n\n  hasProperty(batchId, name) {\n    this._checkBatchId(batchId);\n    assert(typeof name === 'string', name);\n\n    return defined(this._properties[name]) || this._hasPropertyInHierarchy(batchId, name);\n  }\n\n  getPropertyNames(batchId, results) {\n    this._checkBatchId(batchId);\n\n    results = defined(results) ? results : [];\n    results.length = 0;\n\n    const propertyNames = Object.keys(this._properties);\n    results.push(...propertyNames);\n\n    if (this._hierarchy) {\n      this._getPropertyNamesInHierarchy(batchId, results);\n    }\n\n    return results;\n  }\n\n  getProperty(batchId, name) {\n    this._checkBatchId(batchId);\n    assert(typeof name === 'string', name);\n\n    if (this._binaryProperties) {\n      const binaryProperty = this._binaryProperties[name];\n      if (defined(binaryProperty)) {\n        return this._getBinaryProperty(binaryProperty, batchId);\n      }\n    }\n\n    const propertyValues = this._properties[name];\n    if (defined(propertyValues)) {\n      return clone(propertyValues[batchId], true);\n    }\n\n    // EXTENSION: 3DTILES_batch_table_hierarchy\n    if (this._hierarchy) {\n      const hierarchyProperty = this._getHierarchyProperty(batchId, name);\n      if (defined(hierarchyProperty)) {\n        return hierarchyProperty;\n      }\n    }\n\n    return undefined;\n  }\n\n  setProperty(batchId, name, value) {\n    const featureCount = this.featureCount;\n\n    this._checkBatchId(batchId);\n    assert(typeof name === 'string', name);\n\n    if (this._binaryProperties) {\n      const binaryProperty = this._binaryProperties[name];\n      if (binaryProperty) {\n        this._setBinaryProperty(binaryProperty, batchId, value);\n        return;\n      }\n    }\n\n    // EXTENSION: 3DTILES_batch_table_hierarchy\n    if (this._hierarchy) {\n      if (this._setHierarchyProperty(this, batchId, name, value)) {\n        return;\n      }\n    }\n\n    let propertyValues = this._properties[name];\n    if (!defined(propertyValues)) {\n      // Property does not exist. Create it.\n      this._properties[name] = new Array(featureCount);\n      propertyValues = this._properties[name];\n    }\n\n    propertyValues[batchId] = clone(value, true);\n  }\n\n  // PRIVATE METHODS\n\n  _checkBatchId(batchId) {\n    const valid = batchId >= 0 && batchId < this.featureCount;\n    if (!valid) {\n      throw new Error('batchId not in range [0, featureCount - 1].');\n    }\n  }\n\n  _getBinaryProperty(binaryProperty, index) {\n    return binaryProperty.unpack(binaryProperty.typedArray, index);\n  }\n\n  _setBinaryProperty(binaryProperty, index, value) {\n    binaryProperty.pack(value, binaryProperty.typedArray, index);\n  }\n\n  _initializeBinaryProperties() {\n    let binaryProperties: Record<string, any> | null = null;\n    for (const name in this._properties) {\n      const property = this._properties[name];\n      const binaryProperty = this._initializeBinaryProperty(name, property);\n      // Store any information needed to access the binary data, including the typed array,\n      // componentCount (e.g. a VEC4 would be 4), and the type used to pack and unpack (e.g. Cartesian4).\n      if (binaryProperty) {\n        binaryProperties = binaryProperties || {};\n        binaryProperties[name] = binaryProperty;\n      }\n    }\n    return binaryProperties;\n  }\n\n  _initializeBinaryProperty(name, property) {\n    if ('byteOffset' in property) {\n      // This is a binary property\n      const tile3DAccessor = property;\n\n      assert(this.binary, `Property ${name} requires a batch table binary.`);\n      assert(tile3DAccessor.type, `Property ${name} requires a type.`);\n\n      const accessor = createTypedArrayFromAccessor(\n        tile3DAccessor,\n        this.binary.buffer,\n        this.binary.byteOffset | 0,\n        this.featureCount\n      );\n\n      // Store any information needed to access the binary data, including the typed array,\n      // componentCount (e.g. a VEC4 would be 4), and the type used to pack and unpack (e.g. Cartesian4).\n      return {\n        typedArray: accessor.values,\n        componentCount: accessor.size,\n        unpack: accessor.unpacker,\n        pack: accessor.packer\n      };\n    }\n\n    return null;\n  }\n\n  //  EXTENSION SUPPORT: 3DTILES_batch_table_hierarchy\n\n  _hasPropertyInHierarchy(batchId, name) {\n    if (!this._hierarchy) {\n      return false;\n    }\n\n    const result = traverseHierarchy(this._hierarchy, batchId, (hierarchy, instanceIndex) => {\n      const classId = hierarchy.classIds[instanceIndex];\n      const instances = hierarchy.classes[classId].instances;\n      return defined(instances[name]);\n    });\n\n    return defined(result);\n  }\n\n  _getPropertyNamesInHierarchy(batchId, results) {\n    traverseHierarchy(this._hierarchy, batchId, (hierarchy, instanceIndex) => {\n      const classId = hierarchy.classIds[instanceIndex];\n      const instances = hierarchy.classes[classId].instances;\n      for (const name in instances) {\n        if (instances.hasOwnProperty(name)) {\n          if (results.indexOf(name) === -1) {\n            results.push(name);\n          }\n        }\n      }\n    });\n  }\n\n  _getHierarchyProperty(batchId, name) {\n    return traverseHierarchy(this._hierarchy, batchId, (hierarchy, instanceIndex) => {\n      const classId = hierarchy.classIds[instanceIndex];\n      const instanceClass = hierarchy.classes[classId];\n      const indexInClass = hierarchy.classIndexes[instanceIndex];\n      const propertyValues = instanceClass.instances[name];\n      if (defined(propertyValues)) {\n        if (defined(propertyValues.typedArray)) {\n          return this._getBinaryProperty(propertyValues, indexInClass);\n        }\n        return clone(propertyValues[indexInClass], true);\n      }\n      return null;\n    });\n  }\n\n  _setHierarchyProperty(batchTable, batchId, name, value) {\n    const result = traverseHierarchy(this._hierarchy, batchId, (hierarchy, instanceIndex) => {\n      const classId = hierarchy.classIds[instanceIndex];\n      const instanceClass = hierarchy.classes[classId];\n      const indexInClass = hierarchy.classIndexes[instanceIndex];\n      const propertyValues = instanceClass.instances[name];\n      if (defined(propertyValues)) {\n        assert(instanceIndex === batchId, `Inherited property \"${name}\" is read-only.`);\n        if (defined(propertyValues.typedArray)) {\n          this._setBinaryProperty(propertyValues, indexInClass, value);\n        } else {\n          propertyValues[indexInClass] = clone(value, true);\n        }\n        return true;\n      }\n      return false;\n    });\n    return defined(result);\n  }\n}\n"],"mappings":"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"}