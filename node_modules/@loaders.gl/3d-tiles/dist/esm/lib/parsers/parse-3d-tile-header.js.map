{"version":3,"file":"parse-3d-tile-header.js","names":["Tile3DSubtreeLoader","load","LOD_METRIC_TYPE","TILE_REFINEMENT","TILE_TYPE","parseImplicitTiles","replaceContentUrlTemplate","convertS2BoundingVolumetoOBB","getTileType","tile","contentUrl","EMPTY","split","fileExtension","pop","POINTCLOUD","SCENEGRAPH","getRefine","refine","REPLACE","ADD","resolveUri","uri","basePath","urlSchemeRegex","test","url","URL","concat","decodeURI","toString","startsWith","normalizeTileData","options","content","contentUri","id","lodMetricType","GEOMETRIC_ERROR","lodMetricValue","geometricError","transformMatrix","transform","type","normalizeTileHeaders","tileset","root","rootImplicitTilingExtension","getImplicitTilingExtensionData","normalizeImplicitTileHeaders","stack","push","length","children","childHeader","childImplicitTilingExtension","implicitTilingExtension","_tileset$root","_tile$boundingVolume$","subdivisionScheme","maximumLevel","subtreeLevels","subtrees","subtreesUriTemplate","replacedUrlTemplate","subtreeUrl","subtree","contentUrlTemplate","rootLodMetricValue","s2VolumeInfo","boundingVolume","extensions","box","s2VolumeBox","rootBoundingVolume","implicitOptions","normalizeImplicitTileData","rootSubtree","replace","_tile$extensions","implicitTiling"],"sources":["../../../../src/lib/parsers/parse-3d-tile-header.ts"],"sourcesContent":["import type {LoaderOptions} from '@loaders.gl/loader-utils';\nimport {Tile3DSubtreeLoader} from '../../tile-3d-subtree-loader';\nimport {load} from '@loaders.gl/core';\nimport {Tileset3D, LOD_METRIC_TYPE, TILE_REFINEMENT, TILE_TYPE, Tile3D} from '@loaders.gl/tiles';\nimport {ImplicitTilingExtension, Subtree} from '../../types';\nimport type {S2VolumeBox} from './helpers/parse-3d-implicit-tiles';\nimport {parseImplicitTiles, replaceContentUrlTemplate} from './helpers/parse-3d-implicit-tiles';\nimport type {S2VolumeInfo} from '../utils/obb/s2-corners-to-obb';\nimport {convertS2BoundingVolumetoOBB} from '../utils/obb/s2-corners-to-obb';\n\nfunction getTileType(tile) {\n  if (!tile.contentUrl) {\n    return TILE_TYPE.EMPTY;\n  }\n\n  const contentUrl = tile.contentUrl.split('?')[0]; // Discard query string\n  const fileExtension = contentUrl.split('.').pop();\n  switch (fileExtension) {\n    case 'pnts':\n      return TILE_TYPE.POINTCLOUD;\n    case 'i3dm':\n    case 'b3dm':\n    case 'glb':\n    case 'gltf':\n      return TILE_TYPE.SCENEGRAPH;\n    default:\n      return fileExtension;\n  }\n}\n\nfunction getRefine(refine) {\n  switch (refine) {\n    case 'REPLACE':\n    case 'replace':\n      return TILE_REFINEMENT.REPLACE;\n    case 'ADD':\n    case 'add':\n      return TILE_REFINEMENT.ADD;\n    default:\n      return refine;\n  }\n}\n\nfunction resolveUri(uri, basePath) {\n  // url scheme per RFC3986\n  const urlSchemeRegex = /^[a-z][0-9a-z+.-]*:/i;\n\n  if (urlSchemeRegex.test(basePath)) {\n    const url = new URL(uri, `${basePath}/`);\n    return decodeURI(url.toString());\n  } else if (uri.startsWith('/')) {\n    return uri;\n  }\n\n  return `${basePath}/${uri}`;\n}\n\nexport function normalizeTileData(tile, options) {\n  if (!tile) {\n    return null;\n  }\n  if (tile.content) {\n    const contentUri = tile.content.uri || tile.content.url;\n    tile.contentUrl = resolveUri(contentUri, options.basePath);\n  }\n  tile.id = tile.contentUrl;\n  tile.lodMetricType = LOD_METRIC_TYPE.GEOMETRIC_ERROR;\n  tile.lodMetricValue = tile.geometricError;\n  tile.transformMatrix = tile.transform;\n  tile.type = getTileType(tile);\n  tile.refine = getRefine(tile.refine);\n\n  return tile;\n}\n\n// normalize tile headers\nexport async function normalizeTileHeaders(\n  tileset: Tileset3D,\n  options: LoaderOptions\n): Promise<Tileset3D> {\n  const basePath = tileset.basePath;\n  let root: Tileset3D;\n\n  const rootImplicitTilingExtension = getImplicitTilingExtensionData(tileset?.root);\n  if (rootImplicitTilingExtension && tileset.root) {\n    root = await normalizeImplicitTileHeaders(\n      tileset.root,\n      tileset,\n      rootImplicitTilingExtension,\n      options\n    );\n  } else {\n    root = normalizeTileData(tileset.root, tileset);\n  }\n\n  const stack: any[] = [];\n  stack.push(root);\n\n  while (stack.length > 0) {\n    const tile = stack.pop() || {};\n    const children = tile.children || [];\n    for (let childHeader of children) {\n      const childImplicitTilingExtension = getImplicitTilingExtensionData(childHeader);\n      if (childImplicitTilingExtension) {\n        childHeader = await normalizeImplicitTileHeaders(\n          childHeader,\n          tileset,\n          childImplicitTilingExtension,\n          options\n        );\n      } else {\n        normalizeTileData(childHeader, {basePath});\n      }\n\n      stack.push(childHeader);\n    }\n  }\n\n  return root;\n}\n\n/**\n * Do normalisation of implicit tile headers\n * TODO Check if Tile3D class can be a return type here.\n * @param tileset\n */\nexport async function normalizeImplicitTileHeaders(\n  tile: Tile3D,\n  tileset: Tileset3D,\n  implicitTilingExtension: ImplicitTilingExtension,\n  options: LoaderOptions\n) {\n  const basePath = tileset.basePath;\n  const {\n    subdivisionScheme,\n    maximumLevel,\n    subtreeLevels,\n    subtrees: {uri: subtreesUriTemplate}\n  } = implicitTilingExtension;\n  const replacedUrlTemplate = replaceContentUrlTemplate(subtreesUriTemplate, 0, 0, 0, 0);\n  const subtreeUrl = resolveUri(replacedUrlTemplate, basePath);\n  const subtree = await load(subtreeUrl, Tile3DSubtreeLoader, options);\n  const contentUrlTemplate = resolveUri(tile.content.uri, basePath);\n  const refine = tileset?.root?.refine;\n  // @ts-ignore\n  const rootLodMetricValue = tile.geometricError;\n\n  // Replace tile.boundingVolume with the the bounding volume specified by the extensions['3DTILES_bounding_volume_S2']\n  const s2VolumeInfo: S2VolumeInfo = tile.boundingVolume.extensions?.['3DTILES_bounding_volume_S2'];\n  if (s2VolumeInfo) {\n    const box = convertS2BoundingVolumetoOBB(s2VolumeInfo);\n    const s2VolumeBox: S2VolumeBox = {box, s2VolumeInfo};\n    tile.boundingVolume = s2VolumeBox;\n  }\n\n  const rootBoundingVolume = tile.boundingVolume;\n\n  const implicitOptions = {\n    contentUrlTemplate,\n    subtreesUriTemplate,\n    subdivisionScheme,\n    subtreeLevels,\n    maximumLevel,\n    refine,\n    basePath,\n    lodMetricType: LOD_METRIC_TYPE.GEOMETRIC_ERROR,\n    rootLodMetricValue,\n    rootBoundingVolume,\n    getTileType,\n    getRefine\n  };\n\n  return await normalizeImplicitTileData(tile, subtree, implicitOptions);\n}\n\n/**\n * Do implicit data normalisation to create hierarchical tile structure\n * @param tile\n * @param rootSubtree\n * @param options\n * @returns\n */\nexport async function normalizeImplicitTileData(tile, rootSubtree: Subtree, options: any) {\n  if (!tile) {\n    return null;\n  }\n\n  tile.lodMetricType = LOD_METRIC_TYPE.GEOMETRIC_ERROR;\n  tile.lodMetricValue = tile.geometricError;\n  tile.transformMatrix = tile.transform;\n\n  const {children, contentUrl} = await parseImplicitTiles({\n    subtree: rootSubtree,\n    options,\n    s2VolumeBox: tile\n  });\n\n  if (contentUrl) {\n    tile.contentUrl = contentUrl;\n    tile.content = {uri: contentUrl.replace(`${options.basePath}/`, '')};\n  }\n\n  tile.refine = getRefine(tile.refine);\n  tile.type = getTileType(tile);\n  tile.children = children;\n  tile.id = tile.contentUrl;\n\n  return tile;\n}\n\n/**\n * Implicit Tiling data can be in 3DTILES_implicit_tiling for 3DTiles v.Next or directly in implicitTiling object for 3DTiles v1.1.\n * Spec 3DTiles v.Next - https://github.com/CesiumGS/3d-tiles/tree/main/extensions/3DTILES_implicit_tiling\n * Spec 3DTiles v.1.1 - https://github.com/CesiumGS/3d-tiles/tree/draft-1.1/specification/ImplicitTiling\n * @param tile\n * @returns\n */\nfunction getImplicitTilingExtensionData(tile: Tile3D | null): ImplicitTilingExtension {\n  return tile?.extensions?.['3DTILES_implicit_tiling'] || tile?.implicitTiling;\n}\n"],"mappings":"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"}