{"version":3,"file":"tiles-3d-loader.js","names":["path","TILESET_TYPE","LOD_METRIC_TYPE","VERSION","parse3DTile","normalizeTileHeaders","Tiles3DLoader","id","name","module","version","extensions","mimeTypes","tests","parse","options","loadGLTF","decodeQuantizedPositions","isTileset","assetGltfUpAxis","getBaseUri","tileset","dirname","url","parseTile","arrayBuffer","context","tile","content","featureIds","byteOffset","parseTileset","data","_tilesetJson$root","tilesetJson","JSON","TextDecoder","decode","loader","queryString","basePath","root","type","TILES3D","lodMetricType","GEOMETRIC_ERROR","lodMetricValue","loaderOptions","indexOf"],"sources":["../../src/tiles-3d-loader.ts"],"sourcesContent":["import type {LoaderWithParser} from '@loaders.gl/loader-utils';\nimport {path} from '@loaders.gl/loader-utils';\nimport {TILESET_TYPE, LOD_METRIC_TYPE} from '@loaders.gl/tiles';\nimport {VERSION} from './lib/utils/version';\nimport {parse3DTile} from './lib/parsers/parse-3d-tile';\nimport {normalizeTileHeaders} from './lib/parsers/parse-3d-tile-header';\n\n/**\n * Loader for 3D Tiles\n */\nexport const Tiles3DLoader: LoaderWithParser = {\n  id: '3d-tiles',\n  name: '3D Tiles',\n  module: '3d-tiles',\n  version: VERSION,\n  extensions: ['cmpt', 'pnts', 'b3dm', 'i3dm'],\n  mimeTypes: ['application/octet-stream'],\n  tests: ['cmpt', 'pnts', 'b3dm', 'i3dm'],\n  parse,\n  options: {\n    '3d-tiles': {\n      loadGLTF: true,\n      decodeQuantizedPositions: false,\n      isTileset: 'auto',\n      assetGltfUpAxis: null\n    }\n  }\n};\n\nfunction getBaseUri(tileset) {\n  return path.dirname(tileset.url);\n}\n\nasync function parseTile(arrayBuffer, options, context) {\n  const tile = {\n    content: {\n      featureIds: null\n    }\n  };\n  const byteOffset = 0;\n  await parse3DTile(arrayBuffer, byteOffset, options, context, tile.content);\n  return tile.content;\n}\n\nasync function parseTileset(data, options, context) {\n  const tilesetJson = JSON.parse(new TextDecoder().decode(data));\n  // eslint-disable-next-line no-use-before-define\n  tilesetJson.loader = options.loader || Tiles3DLoader;\n  tilesetJson.url = context.url;\n  tilesetJson.queryString = context.queryString;\n\n  // base path that non-absolute paths in tileset are relative to.\n  tilesetJson.basePath = getBaseUri(tilesetJson);\n  tilesetJson.root = await normalizeTileHeaders(tilesetJson, options);\n\n  tilesetJson.type = TILESET_TYPE.TILES3D;\n\n  tilesetJson.lodMetricType = LOD_METRIC_TYPE.GEOMETRIC_ERROR;\n  tilesetJson.lodMetricValue = tilesetJson.root?.lodMetricValue || 0;\n\n  return tilesetJson;\n}\n\nasync function parse(data, options, context) {\n  // auto detect file type\n  const loaderOptions = options['3d-tiles'] || {};\n  let isTileset;\n  if (loaderOptions.isTileset === 'auto') {\n    isTileset = context.url && context.url.indexOf('.json') !== -1;\n  } else {\n    isTileset = loaderOptions.isTileset;\n  }\n\n  if (isTileset) {\n    data = await parseTileset(data, options, context);\n  } else {\n    data = await parseTile(data, options, context);\n  }\n\n  return data;\n}\n"],"mappings":"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"}